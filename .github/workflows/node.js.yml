name: Node.js CI

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

jobs:
  test:
    name: Run unit & integration tests
    runs-on: self-hosted
    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Run Vitest
        run: npm test

      - name: Notify Shortcut if tests fail
        if: failure()
        run: |
          PR_TITLE=$(jq -r '.pull_request.title' < "$GITHUB_EVENT_PATH")
          STORY_ID=$(echo "$PR_TITLE" | grep -o 'sc-[0-9]\+')

          if [ -n "$STORY_ID" ]; then
            curl -X POST https://api.app.shortcut.com/api/v3/stories/$STORY_ID/comments \
              -H "Content-Type: application/json" \
              -H "Shortcut-Token: $SHORTCUT_API_TOKEN" \
              -d "{\"text\": \"❌ Tests failed in CI. Please fix before merging.\"}"
          else
            echo "No STORY_ID found in commit message, skipping Shortcut message."
          fi

  deploy:
    name: Build & Deploy to Production
    runs-on: self-hosted
    needs: test
    if: github.event_name == 'push'
    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Build for production
        run: npm run build

      - name: Sync build to production folder
        run: rsync -av --delete dist/ /var/www/devoped-app/

      - name: Start or Reload application via PM2
        run: |
          cd /var/www/devoped-app

          # Ahora inicio o recargo el preview dentro de /var/www/devoped-app
          if pm2 list | grep -q "devoped-app"; then
            echo "Recargando PM2 devoped-app"
            pm2 reload devoped-app
          else
            echo "No se encontró 'devoped-app' en PM2 → arrancando serve"
            pm2 start /home/devoper/.nvm/versions/node/v22.14.0/bin/serve \
            --name devoped-app -- -s /var/www/devoped-app -l 3000
          fi

      - name: Move Story to Done in Shortcut
        run: |
          PR_TITLE=$(git log -1 --pretty=%B)
          STORY_ID=$(echo "$PR_TITLE" | grep -o 'sc-[0-9]\+')

          if [ -n "$STORY_ID" ]; then
            curl -X PUT https://api.app.shortcut.com/api/v3/stories/$STORY_ID \
              -H "Content-Type: application/json" \
              -H "Shortcut-Token: $SHORTCUT_API_TOKEN" \
              -d '{"workflow_state_id": 500000010}'
          else
            echo "No STORY_ID found in commit message, skipping Shortcut update."
          fi