name: Node.js CI

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

jobs:
  test:
    name: Run unit & integration tests
    runs-on: self-hosted
    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Run Vitest
        id: vitest
        run: npm test

      - name: Verificar √∫ltimos 5 d√≠gitos del SHORTCUT_API_TOKEN
        env:
          SHORTCUT_API_TOKEN: ${{ secrets.SHORTCUT_API_TOKEN }}
        run: |
          echo "‚úÖ SHORTCUT_API_TOKEN est√° definida."
          echo -n "üîí √öltimos 5 caracteres del token: "
          echo "${SHORTCUT_API_TOKEN: -5}"

      # NUEVO: Notificar a Shortcut tras tests
      - name: Notify Shortcut of test result   # NOTIFICAR SHORTCUT
        if: ${{ always() }}
        env:
          # Pasamos el nombre de la rama del PR
          BRANCH_NAME: ${{ github.head_ref }}
          # Resultado del paso de tests (success/failure)
          RESULT: ${{ steps.vitest.outcome }}
        continue-on-error: true   # No provocar fallo de pipeline si falla este paso
        run: |
          echo "Resultado de Vitest: $RESULT"
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Mensaje del √∫ltimo commit: $COMMIT_MSG"
          echo "Nombre de rama (PR): $BRANCH_NAME"
          # Buscar n√∫mero en rama o commit como posible ID de historia
          STORY_ID=$(echo "$BRANCH_NAME $COMMIT_MSG" | grep -Eo '\b[0-9]+\b' | head -n1)
          echo "ID de historia encontrado: $STORY_ID"
          if [ -z "$STORY_ID" ]; then
            echo "No se encontr√≥ ID de historia en la rama o commit. Saltando notificaci√≥n."
            exit 0
          fi
          if [ "$RESULT" = "failure" ]; then
            echo "Tests fallaron. Enviando mensaje a la historia $STORY_ID..."
            curl -X POST -H "Content-Type: application/json" -H "Shortcut-Token: $SHORTCUT_API_TOKEN" \
                 -d "{ \"text\": \"‚ö†Ô∏è Los tests han fallado para esta historia (branch: $BRANCH_NAME). Revisa los detalles del CI.\" }" \
                 "https://api.app.shortcut.com/api/v3/stories/$STORY_ID/comments"
          else
            echo "Los tests pasaron correctamente. No se env√≠a notificaci√≥n a Shortcut."
          fi

  deploy:
    name: Build & Deploy to Production
    runs-on: self-hosted
    needs: test
    if: github.event_name == 'push'
    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Build for production
        run: npm run build

      - name: Sync build to production folder
        run: rsync -av --delete dist/ /var/www/devoped-app/

      - name: Start or Reload application via PM2
        run: |
          cd /var/www/devoped-app
          if pm2 list | grep -q "devoped-app"; then
            echo "Recargando PM2 devoped-app"
            pm2 reload devoped-app
          else
            echo "No se encontr√≥ 'devoped-app' en PM2 ‚Üí arrancando serve"
            pm2 start /home/devoper/.nvm/versions/node/v22.14.0/bin/serve \
              --name devoped-app -- -s /var/www/devoped-app -l 3000
          fi

      # NUEVO: Notificar a Shortcut tras despliegue exitoso
      - name: Notify Shortcut of deployment   # NOTIFICAR SHORTCUT
        if: ${{ always() }}
        continue-on-error: true
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Mensaje del √∫ltimo commit en main: $COMMIT_MSG"
          STORY_ID=$(echo "$COMMIT_MSG" | grep -Eo '\b[0-9]+\b' | head -n1)
          echo "ID de historia encontrado en commit: $STORY_ID"
          if [ -z "$STORY_ID" ]; then
            echo "No se encontr√≥ ID de historia en el commit de merge. Saltando notificaci√≥n."
            exit 0
          fi
          echo "Enviando mensaje de despliegue exitoso para historia $STORY_ID..."
          curl -X POST -H "Content-Type: application/json" -H "Shortcut-Token: $SHORTCUT_API_TOKEN" \
               -d "{ \"text\": \"‚úÖ La historia #$STORY_ID ha pasado los tests y fue mergeada en la rama main con √©xito.\" }" \
               "https://api.app.shortcut.com/api/v3/stories/$STORY_ID/comments"
